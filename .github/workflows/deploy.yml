name: CI/CD

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 코드 가져오기
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. JDK 설정 (Java 21)
      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '21'

      # 3. Gradle 빌드
      - name: Build with Gradle
        run: ./gradlew clean build -x test

      # 4. JAR 파일 빌드 확인
      - name: Check JAR existence
        run: |
          if [ ! -f build/libs/battlemap-be-0.0.1-SNAPSHOT.jar ]; then
            echo ">>> ❌ ERROR: JAR file does not exist. Build may have failed."
            exit 1
          else
            echo ">>> JAR file exists."
          fi

      # 5. SSH Key 설정
      - name: Deploy Key Setup
        run: |
          echo "${{ secrets.EC2_KEY }}" | base64 -d > deploy_key.pem
          chmod 600 deploy_key.pem
          eval "$(ssh-agent -s)"
          ssh-add deploy_key.pem

      # 6. EC2에서 기존 프로세스 종료 및 충돌 JAR 제거
      - name: Clean old jar and process
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key_path: deploy_key.pem
          script: |
            APP_DIR=/home/ubuntu
            TARGET_DIR=$APP_DIR/build/libs # 타겟 디렉토리 변수 정의
            
            echo ">>> Stopping existing systemd service if exists..."
            sudo systemctl stop battlemap-app || true 
            sleep 3

            # JAR 파일을 받을 디렉토리가 존재하도록 보장
            mkdir -p $TARGET_DIR
            echo ">>> Target directory $TARGET_DIR ensured."
            
            echo ">>> Removing old jar and logs..."
            # /home/ubuntu/build/libs/ 경로의 JAR 파일을 삭제
            sudo rm -f $TARGET_DIR/battlemap-be-0.0.1-SNAPSHOT.jar
            sudo rm -rf $APP_DIR/log.out # 로그는 홈 디렉토리에 유지

      # 7. 새 JAR 전송 (타겟 경로 수정)
      - name: Copy new jar to EC2
        uses: appleboy/scp-action@v0.1.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key_path: deploy_key.pem
          source: build/libs/battlemap-be-0.0.1-SNAPSHOT.jar
          # 명시적으로 /home/ubuntu/build/libs/ 로 전송
          target: /home/ubuntu/build/libs/
          verbose: true

      # 8. JAR 전송 확인 (경로 일치)
      - name: Verify JAR on EC2
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key_path: deploy_key.pem
          script: |
            # /home/ubuntu/build/libs/ 경로를 확인
            JAR_PATH="/home/ubuntu/build/libs/battlemap-be-0.0.1-SNAPSHOT.jar" 
            if [ ! -f "$JAR_PATH" ]; then
              echo ">>> ❌ ERROR: JAR file not found on EC2. SCP failed."
              exit 1
            else
              echo ">>> JAR file successfully uploaded to EC2."
            fi

      # 9. systemd 서비스 생성 및 실행 (경로 일치)
      - name: Configure and start systemd service
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key_path: deploy_key.pem
          script: |
            APP_DIR=/home/ubuntu
            # JAR_FILE 변수도 경로를 포함하도록 정의
            JAR_FILE=build/libs/battlemap-be-0.0.1-SNAPSHOT.jar
            SERVICE_FILE=/etc/systemd/system/battlemap-app.service

            echo ">>> Creating/updating systemd service..."
            echo "[Unit]
            Description=Battlemap Spring Boot Application
            After=network.target

            [Service]
            User=ubuntu
            WorkingDirectory=$APP_DIR
            ExecStart=/usr/bin/java -Xms512m -Xmx1024m \
            -Dspring.datasource.url='${{ secrets.DB_URL }}' \
            -Dspring.datasource.username='${{ secrets.DB_USERNAME }}' \
            -Dspring.datasource.password='${{ secrets.DB_PASSWORD }}' \
            -DKAKAO_API_KEY='${{ secrets.KAKAO_API_KEY }}' \
            -Dserver.port=8081 \
            -Dspring.datasource.hikari.maximum-pool-size=10 \
            -jar $APP_DIR/$JAR_FILE \
            > $APP_DIR/log.out 2>&1
            Restart=always
            TimeoutStartSec=120

            [Install]
            WantedBy=multi-user.target" | sudo tee $SERVICE_FILE

            echo ">>> Reloading systemd daemon..."
            sudo systemctl daemon-reload
            sudo systemctl enable battlemap-app
            sudo systemctl restart battlemap-app

            echo ">>> Waiting for service to start..."
            for i in {1..12}; do
              if systemctl is-active --quiet battlemap-app; then
                echo ">>> ✅ Service is running."
                break
              else
                echo ">>> Waiting..."
                sleep 5
              fi
            done
            
            # 서비스 시작 실패 시 50라인 로그 출력
            if ! systemctl is-active --quiet battlemap-app; then
              echo ">>> ⚠️ App failed to start after timeout. Last 50 log lines:"
              tail -n 50 $APP_DIR/log.out
              exit 1
            fi

            echo ">>> Checking port 8081..."
            if sudo ss -tulnp | grep 8081; then
              echo ">>> ✅ App is listening on port 8081"
            else
              echo ">>> ⚠️ Port 8081 is not active. Last 50 log lines:"
              tail -n 50 $APP_DIR/log.out
              exit 1
            fi

            echo ">>> Checking logs for errors..."
            if grep -i "error\|exception" $APP_DIR/log.out; then
              echo ">>> ❌ Errors detected in logs! Review log.out for details."
              exit 1 
            else
              echo ">>> ✅ No critical errors in logs."
            fi
