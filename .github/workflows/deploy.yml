name: CI/CD

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 코드 가져오기
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. JDK 설정 (Java 17)
      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '17'

      # 3. Gradle 빌드
      - name: Build with Gradle
        run: ./gradlew clean build -x test

      # 4. SSH Key 설정
      - name: Deploy Key Setup
        run: |
          # EC2_KEY Secret을 Base64 디코딩하여 deploy_key.pem 파일로 생성
          echo "${{ secrets.EC2_KEY }}" | base64 -d > deploy_key.pem
          chmod 600 deploy_key.pem
          eval "$(ssh-agent -s)"
          ssh-add deploy_key.pem

      # 5. EC2에서 기존 프로세스 및 jar 제거 (종료 안정성 확보)
      - name: Clean old jar and process
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key_path: deploy_key.pem
          script: |
            echo ">>> Stopping running app..."
            # 실행 중인 프로세스 ID 찾기
            CURRENT_PID=$(pgrep -f 'battlemap-be-0.0.1-SNAPSHOT.jar')
            
            if [ -z "$CURRENT_PID" ]; then
              echo ">>> App is not running (PID not found)."
            else
              echo ">>> Killing process $CURRENT_PID"
              # 강제 종료 (kill -9) 후, 종료 코드가 0이 아니어도 파이프라인이 멈추지 않도록 || true 추가
              kill -9 "$CURRENT_PID" || true
              sleep 3
            fi
            
            echo ">>> Removing old jar..."
            # JAR 파일이 없을 수도 있으므로 -f 옵션 사용
            rm -f /home/ubuntu/battlemap-be-0.0.1-SNAPSHOT.jar
            echo ">>> Clean complete"

      # 6. 새 jar 전송
      - name: Copy new jar to EC2
        uses: appleboy/scp-action@v0.1.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key_path: deploy_key.pem
          source: build/libs/battlemap-be-0.0.1-SNAPSHOT.jar
          target: /home/ubuntu/

      # 7. 새 앱 실행 및 포트 확인 (파일 체크 및 충분한 대기 시간 포함)
      - name: Restart app and check port
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key_path: deploy_key.pem
          script: |
            JAR_PATH="/home/ubuntu/battlemap-be-0.0.1-SNAPSHOT.jar"
            
            # --- 1. JAR 파일 존재 여부 확인 및 권한 부여 ---
            if [ ! -f "$JAR_PATH" ]; then
              echo ">>> ❌ ERROR: JAR file not found at $JAR_PATH"
              # 파일이 없으면 즉시 종료하여 Step 6의 실패를 확인하도록 유도
              exit 1
            fi

            # 파일이 존재하면 실행 권한 부여 (혹시 모를 권한 문제 방지)
            chmod +x "$JAR_PATH"
            echo ">>> JAR file verified and permissions set."
            
            # --- 2. 앱 실행 ---
            echo ">>> Starting new app..."
            # 모든 -D 옵션을 따옴표로 감싸고, 한 줄에 이어서 구문 오류 최소화
            nohup java \
              -Dspring.datasource.url="${{ secrets.DB_URL }}" \
              -Dspring.datasource.username="${{ secrets.DB_USERNAME }}" \
              -Dspring.datasource.password="${{ secrets.DB_PASSWORD }}" \
              -DKAKAO_API_KEY="${{ secrets.KAKAO_API_KEY }}" \
              -Dserver.port=8081 \
              -jar "$JAR_PATH" \
              > /home/ubuntu/log.out 2>&1 &

            # Spring Boot가 충분히 시작할 시간을 줍니다
            sleep 15
            
            # --- 3. 포트 확인 및 디버깅 로그 출력 ---
            echo ">>> Checking port 8081..."
            if sudo ss -tulnp | grep 8081; then
              echo ">>> ✅ App is running on port 8081"
            else
              echo ">>> ⚠️ App failed to start. Last 50 log lines:"
              tail -n 50 /home/ubuntu/log.out
              # 실패 시 CI/CD 워크플로우가 멈추도록 exit code를 반환
              exit 1
            fi
