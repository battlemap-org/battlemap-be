name: CI/CD

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 코드 가져오기
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. JDK 설정 (Java 17)
      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '17'

      # 3. Gradle 빌드
      - name: Build with Gradle
        run: ./gradlew clean build -x test

      # 4. SSH 키 추가
      - name: Add SSH Key
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.EC2_KEY }}

      # 5. EC2로 jar 전송
      - name: Copy jar to EC2
        uses: appleboy/scp-action@v0.1.3
        with:
          host: 3.35.246.97
          username: ubuntu
          source: build/libs/battlemap-be-0.0.1-SNAPSHOT.jar
          target: /home/ubuntu/

      # 6. EC2에서 systemd 서비스 등록/재시작
      - name: Deploy as systemd service
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: 3.35.246.97
          username: ubuntu
          script: |
            SERVICE_FILE=/etc/systemd/system/battlemap-be.service

            # 서비스 파일 생성
            sudo tee $SERVICE_FILE > /dev/null <<EOF
            [Unit]
            Description=Battlemap BE Service
            After=network.target

            [Service]
            User=ubuntu
            WorkingDirectory=/home/ubuntu
            ExecStart=/usr/bin/java -jar /home/ubuntu/battlemap-be-0.0.1-SNAPSHOT.jar
            Restart=always
            RestartSec=10
            Environment="DB_URL=jdbc:mysql://battlemap-server.clkuus6o63hk.ap-northeast-2.rds.amazonaws.com/battlemap_db"
            Environment="DB_USERNAME=battlemap_user"
            Environment="DB_PASSWORD=${{ secrets.DB_PASSWORD }}"
            Environment="KAKAO_API_KEY=${{ secrets.KAKAO_API_KEY }}"

            [Install]
            WantedBy=multi-user.target
            EOF

            # systemd 적용 및 재시작
            sudo systemctl daemon-reload
            sudo systemctl enable battlemap-be
            sudo systemctl restart battlemap-be
            sudo systemctl status battlemap-be --no-pager
