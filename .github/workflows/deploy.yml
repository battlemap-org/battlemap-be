name: CI/CD

on:
push:
branches:
  - main

jobs:
build-and-deploy:
runs-on: ubuntu-latest

steps:
  # 1. ÏΩîÎìú Í∞ÄÏ†∏Ïò§Í∏∞
  - name: Checkout code
    uses: actions/checkout@v3

  # 2. JDK ÏÑ§Ï†ï (Java 21)
  - name: Set up JDK
    uses: actions/setup-java@v3
    with:
      distribution: temurin
      java-version: '21'

  # 3. Gradle ÎπåÎìú
  - name: Build with Gradle
    run: ./gradlew clean build -x test

  # 4. JAR ÌååÏùº ÎπåÎìú ÌôïÏù∏
  - name: Check JAR existence
    run: |
      if [ ! -f build/libs/battlemap-be-0.0.1-SNAPSHOT.jar ]; then
        echo ">>> ‚ùå ERROR: JAR file does not exist. Build may have failed."
        exit 1
      else
        echo ">>> JAR file exists."
      fi

  # 5. SSH Key ÏÑ§Ï†ï
  - name: Deploy Key Setup
    run: |
      echo "${{ secrets.EC2_KEY }}" | base64 -d > deploy_key.pem
      chmod 600 deploy_key.pem
      eval "$(ssh-agent -s)"
      ssh-add deploy_key.pem

  # 6. EC2ÏóêÏÑú Í∏∞Ï°¥ ÌîÑÎ°úÏÑ∏Ïä§ Ï¢ÖÎ£å Î∞è ÏûòÎ™ªÎêú JAR Ï†úÍ±∞
  - name: Clean old jar and process
    uses: appleboy/ssh-action@v0.1.7
    with:
      host: ${{ secrets.EC2_HOST }}
      username: ubuntu
      key_path: deploy_key.pem
      script: |
        TARGET_DIR="/home/ubuntu/build/libs"
        
        # üí° [ÌïµÏã¨ ÏàòÏ†ï] SCPÍ∞Ä ÌååÏùºÏùÑ Î≥µÏÇ¨Ìï† ÎîîÎ†âÌÜ†Î¶¨Î•º ÎØ∏Î¶¨ ÏÉùÏÑ± (-p ÏòµÏÖòÏúºÎ°ú Ïù¥ÎØ∏ Ï°¥Ïû¨Ìï¥ÎèÑ Ïò§Î•ò ÏóÜÏùå)
        mkdir -p "$TARGET_DIR"
        echo ">>> Target directory $TARGET_DIR ensured."
        
        echo ">>> Checking for running app..."
        PIDS=$(ps -ef | grep 'battlemap-be-0.0.1-SNAPSHOT.jar' | grep -v grep | awk '{print $2}')
        
        if [ -n "$PIDS" ]; then
          echo ">>> Found running app(s): $PIDS"
          kill -9 $PIDS
          sleep 3
        else
          echo ">>> No running app found."
        fi

        # Í∏∞Ï°¥ JAR ÌååÏùº Ï†úÍ±∞
        if [ -e "$TARGET_DIR/battlemap-be-0.0.1-SNAPSHOT.jar" ]; then
          rm -f "$TARGET_DIR/battlemap-be-0.0.1-SNAPSHOT.jar"
          echo ">>> Old jar removed."
        fi

  # 7. ÏÉà JAR Ï†ÑÏÜ°
  - name: Copy new jar to EC2
    uses: appleboy/scp-action@v0.1.3
    with:
      host: ${{ secrets.EC2_HOST }}
      username: ubuntu
      key_path: deploy_key.pem
      source: build/libs/battlemap-be-0.0.1-SNAPSHOT.jar
      target: /home/ubuntu/build/libs/

  # 8. JAR Ï†ÑÏÜ° ÌôïÏù∏
  - name: Verify JAR on EC2
    uses: appleboy/ssh-action@v0.1.7
    with:
      host: ${{ secrets.EC2_HOST }}
      username: ubuntu
      key_path: deploy_key.pem
      script: |
        JAR_PATH="/home/ubuntu/build/libs/battlemap-be-0.0.1-SNAPSHOT.jar"
        if [ ! -f "$JAR_PATH" ]; then
          echo ">>> ‚ùå ERROR: JAR file not found on EC2. SCP failed."
          exit 1
        else
          echo ">>> JAR file successfully uploaded to EC2."
        fi

  # 9. ÏÉà Ïï± Ïã§Ìñâ Î∞è Ìè¨Ìä∏ ÌôïÏù∏
  - name: Restart app and check port
    uses: appleboy/ssh-action@v0.1.7
    with:
      host: ${{ secrets.EC2_HOST }}
      username: ubuntu
      key_path: deploy_key.pem
      script: |
        JAR_PATH="/home/ubuntu/build/libs/battlemap-be-0.0.1-SNAPSHOT.jar"

        # JAR ÌååÏùº Í∂åÌïú Î∂ÄÏó¨
        chmod +x "$JAR_PATH"
        echo ">>> JAR file verified and permissions set."
        
        # Ïï± Ïã§Ìñâ
        echo ">>> Starting new app..."
        nohup java \
          -Dspring.datasource.url="${{ secrets.DB_URL }}" \
          -Dspring.datasource.username="${{ secrets.DB_USERNAME }}" \
          -Dspring.datasource.password="${{ secrets.DB_PASSWORD }}" \
          -DKAKAO_API_KEY="${{ secrets.KAKAO_API_KEY }}" \
          -Dserver.port=8081 \
          -jar "$JAR_PATH" \
          > /home/ubuntu/log.out 2>&1 &

        # Spring Boot Ï∂©Î∂ÑÌûà ÏãúÏûë ÎåÄÍ∏∞
        sleep 20
        
        # Ìè¨Ìä∏ ÌôïÏù∏
        echo ">>> Checking port 8081..."
        if sudo ss -tulnp | grep 8081; then
          echo ">>> ‚úÖ App is running on port 8081"
        else
          echo ">>> ‚ö†Ô∏è App failed to start. Last 50 log lines:"
          tail -n 50 /home/ubuntu/log.out
          exit 1
        fi
