name: CI/CD

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 코드 가져오기
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. JDK 설정 (Java 17)
      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '17'

      # 3. Gradle 빌드
      - name: Build with Gradle
        run: ./gradlew clean build -x test

      # 4. SSH Key 설정
      - name: Deploy Key Setup
        run: |
          # EC2_KEY Secret을 Base64 디코딩하여 deploy_key.pem 파일로 생성
          echo "${{ secrets.EC2_KEY }}" | base64 -d > deploy_key.pem
          chmod 600 deploy_key.pem
          eval "$(ssh-agent -s)"
          ssh-add deploy_key.pem

      # 5. EC2에서 기존 프로세스 및 jar 제거 (종료 안정성 확보)
      - name: Clean old jar and process
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key_path: deploy_key.pem
          script: |
            echo ">>> Stopping running app..."
            
            # **[최종 수정]** pgrep/kill 조합을 사용하되, 메인 셸의 exit 0을 보장
            # 프로세스가 없든, kill에 의해 종료되든 최종 코드는 0이 되도록 || true와 exit 0을 조합
            pgrep -f 'battlemap-be-0.0.1-SNAPSHOT.jar' | xargs -r kill -9 || true
            sleep 3
            
            echo ">>> Removing old jar..."
            # JAR 파일 제거
            rm -f /home/ubuntu/battlemap-be-0.0.1-SNAPSHOT.jar
            
            echo ">>> Clean complete"
            # 스크립트 마지막에 종료 코드 0을 명시적으로 반환 (가장 중요)
            exit 0

      # 6. 새 jar 전송
      - name: Copy new jar to EC2
        uses: appleboy/scp-action@v0.1.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key_path: deploy_key.pem
          source: build/libs/battlemap-be-0.0.1-SNAPSHOT.jar
          target: /home/ubuntu/

      # 7. 새 앱 실행 및 포트 확인
      - name: Restart app and check port
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key_path: deploy_key.pem
          script: |
            JAR_PATH="/home/ubuntu/battlemap-be-0.0.1-SNAPSHOT.jar"
            
            # --- 1. JAR 파일 존재 여부 확인 및 권한 부여 ---
            if [ ! -f "$JAR_PATH" ]; then
              echo ">>> ❌ ERROR: JAR file not found at $JAR_PATH. Copy step failed!"
              exit 1
            fi

            # 파일이 존재하면 실행 권한 부여
            chmod +x "$JAR_PATH"
            echo ">>> JAR file verified and permissions set."
            
            # --- 2. 앱 실행 ---
            echo ">>> Starting new app..."
            nohup java \
              -Dspring.datasource.url="${{ secrets.DB_URL }}" \
              -Dspring.datasource.username="${{ secrets.DB_USERNAME }}" \
              -Dspring.datasource.password="${{ secrets.DB_PASSWORD }}" \
              -DKAKAO_API_KEY="${{ secrets.KAKAO_API_KEY }}" \
              -Dserver.port=8081 \
              -jar "$JAR_PATH" \
              > /home/ubuntu/log.out 2>&1 &

            # Spring Boot가 충분히 시작할 시간을 줍니다
            sleep 15
            
            # --- 3. 포트 확인 및 디버깅 로그 출력 ---
            echo ">>> Checking port 8081..."
            if sudo ss -tulnp | grep 8081; then
              echo ">>> ✅ App is running on port 8081"
            else
              echo ">>> ⚠️ App failed to start. Last 50 log lines:"
              tail -n 50 /home/ubuntu/log.out
              # 실패 시 CI/CD 워크플로우가 멈추도록 exit code를 반환
              exit 1
            fi